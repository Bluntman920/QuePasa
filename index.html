<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Que Pasa / ¬øQu√© Pasa?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="QuePasaLogo.png" type="image/png">
  <style>
    body {
      background: #23272a;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container {
      max-width: 560px;
      margin: 0 auto;
      padding: 34px 10px 26px 10px;
      text-align: center;
    }
    .logo {
      width: 120px;
      margin: 0 auto 18px auto;
      display: block;
      filter: drop-shadow(0 2px 28px #1da36555);
    }
    .title {
      font-size: 2.4em;
      color: #1da365;
      font-weight: bold;
      margin-bottom: 10px;
      letter-spacing: 0.06em;
      text-shadow: 0 2px 16px #0008;
    }
    .subtitle {
      font-size: 1.14em;
      color: #fff8;
      margin-bottom: 24px;
      line-height: 1.45em;
    }
    .room-qr {
      background: #fff;
      border-radius: 14px;
      padding: 14px;
      margin: 18px 0 10px 0;
      box-shadow: 0 2px 12px #0003;
      display: inline-block;
    }
    .room-code {
      font-size: 2em;
      color: #1da365;
      background: #222b;
      padding: 13px 28px;
      border-radius: 14px;
      margin-bottom: 12px;
      letter-spacing: 0.22em;
      font-family: 'Courier New', monospace;
      display: inline-block;
      box-shadow: 0 2px 8px #0002;
      user-select: all;
    }
    .scan-btn {
      background: #00d64b;
      color: #fff;
      border-radius: 10px;
      border: none;
      padding: 13px 30px;
      font-size: 1.13em;
      font-weight: bold;
      margin: 18px 0 6px 0;
      box-shadow: 0 2px 8px #0003;
      cursor: pointer;
      transition: background 0.17s, transform 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .scan-btn:hover {
      background: #009c34;
      transform: scale(1.04);
    }
    #qr-reader {
      margin: 12px auto 6px auto;
      width: 250px;
      display: none;
      border-radius: 13px;
      overflow: hidden;
      box-shadow: 0 2px 12px #0003;
      background: #23272a;
    }
    .chat-box {
      background: #252a2e;
      border-radius: 14px;
      box-shadow: 0 1px 8px #0003;
      padding: 14px 0 6px 0;
      margin: 28px 0 0 0;
      display: flex;
      flex-direction: column;
      height: 32vh;
      min-height: 120px;
      max-height: 260px;
      overflow: hidden;
    }
    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 0 18px 0 18px;
      display: flex;
      flex-direction: column;
    }
    .chat-message {
      margin: 7px 0;
      padding: 9px 15px;
      max-width: 81%;
      border-radius: 10px;
      background: #1da36522;
      color: #fff;
      font-size: 1.13em;
      font-weight: 500;
      word-break: break-word;
      box-shadow: 0 1px 2px #0001;
      transition: background 0.18s;
    }
    .chat-message.me {
      align-self: flex-end;
      background: #1da365;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 2px 10px #1da36522;
    }
    .chat-message.system {
      background: #23272a;
      color: #1da365;
      font-size: 1em;
      align-self: center;
      font-style: italic;
      box-shadow: none;
    }
    .chat-input-row {
      display: flex;
      gap: 8px;
      padding: 7px 10px 8px 10px;
      align-items: center;
    }
    .chat-input {
      flex: 1;
      font-size: 1.14em;
      padding: 11px 14px;
      border-radius: 7px;
      border: none;
      outline: none;
      background: #31343a;
      color: #fff;
      box-shadow: 0 1px 3px #0002;
    }
    .chat-send-btn {
      background: #1da365;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 21px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.17s;
      box-shadow: 0 1px 4px #0002;
    }
    .chat-send-btn:hover {
      background: #149150;
    }
    .leave-btn {
      background: #e74c3c;
      color: #fff;
      padding: 13px 30px;
      border-radius: 10px;
      border: none;
      font-size: 1.04em;
      font-weight: bold;
      margin: 36px 0 0 0;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      transition: background 0.13s;
    }
    .leave-btn:hover { background: #c0392b; }
    .cashapp-support {
      margin: 38px auto 8px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 13px;
      background: #151a1d;
      border-radius: 13px;
      padding: 23px 16px 12px 16px;
      box-shadow: 0 2px 20px #00d64b22;
      max-width: 350px;
    }
    .cashapp-btn {
      display: flex;
      align-items: center;
      gap: 13px;
      background: #00d64b;
      color: #fff;
      font-size: 1.22em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      padding: 13px 32px;
      cursor: pointer;
      box-shadow: 0 2px 8px #0003;
      text-decoration: none;
      transition: background 0.18s, transform 0.15s;
    }
    .cashapp-btn:hover {
      background: #009c34;
      transform: scale(1.03);
      text-decoration: none;
      color: #fff;
    }
    .cashapp-logo {
      width: 38px;
      height: 38px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 1px 5px #0002;
      object-fit: cover;
      border: 2px solid #fff;
    }
    .cashapp-user {
      font-size: 1.07em;
      color: #00d64b;
      font-weight: bold;
      letter-spacing: 0.02em;
      margin-top: 2px;
      margin-bottom: 0;
      background: #23272a;
      padding: 7px 22px;
      border-radius: 8px;
      display: inline-block;
      box-shadow: 0 1px 5px #00d64b11;
    }
    .cashapp-desc {
      font-size: 0.98em;
      color: #fff8;
      margin-top: 2px;
      margin-bottom: 0;
      line-height: 1.4em;
    }
    @media (max-width: 600px) {
      .container { padding: 8px 2vw; }
      .logo { width: 74px; }
      .title { font-size: 1.13em; }
      .room-code { font-size: 1em; }
      .cashapp-support { max-width: 100vw; }
      .chat-box { min-height: 80px; max-height: 165px; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <div class="container">
    <img class="logo" src="QuePasaLogo.png" alt="Que Pasa logo"/>
    <div class="title">Que Pasa <span style="color:#fff8;">/ ¬øQu√© Pasa?</span></div>
    <div class="subtitle">
      Scan this code to join the room on another phone.<br>
      <span style="color:#fff8;">Escanea este c√≥digo para unirte a la sala en otro tel√©fono.</span><br>
      or tap below to scan someone else's code.<br>
      <span style="color:#fff8;">o toca abajo para escanear el c√≥digo de otra persona.</span>
    </div>
    <canvas id="qrCanvas" class="room-qr"></canvas>
    <div class="room-code" id="roomCodeDisplay">Room Code / C√≥digo de Sala</div>
    <button class="scan-btn" id="scanQrBtn">
      <img src="camera.svg" alt="Camera" style="height:1.2em;width:1.2em;vertical-align:middle;filter:drop-shadow(0 1px 4px #0002);" />
      Scan QR to Join Another Room / Escanea el QR para Unirte a Otra Sala
    </button>
    <div id="qr-reader"></div>
    <div class="chat-box">
      <div class="chat-history" id="chatHistory"></div>
      <form class="chat-input-row" id="chatForm" autocomplete="off">
        <input class="chat-input" id="chatInput" placeholder="Type a message... / Escribe un mensaje..." autocomplete="off" />
        <button type="submit" class="chat-send-btn">Send / Enviar</button>
      </form>
    </div>
    <button class="leave-btn" id="leaveBtn">Leave Room / Salir de la Sala</button>
    <div class="cashapp-support">
      <a class="cashapp-btn" href="https://cash.app/$QuePasaAPP" target="_blank" rel="noopener">
        <img class="cashapp-logo" src="CashappQR.png" alt="Cash App Logo"/>
        Support Que Pasa on Cash App / Apoya a Que Pasa en Cash App
      </a>
      <span class="cashapp-user">$QuePasaAPP</span>
      <div class="cashapp-desc">
        Thank you for supporting this free, ad-free tool!<br>
        <span style="color:#fff;">¬°Gracias por apoyar esta herramienta gratuita y sin anuncios!</span><br>
        Every tip helps keep it running for everyone. üôè<br>
        <span style="color:#fff;">Cada propina ayuda a mantenerla funcionando para todos. üôè</span>
      </div>
    </div>
  </div>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDNz_qKPg7LfhVcXtKKTcTU-ynfBLkOSC4",
      authDomain: "quepasaapp-2e0f7.firebaseapp.com",
      databaseURL: "https://quepasaapp-2e0f7-default-rtdb.firebaseio.com",
      projectId: "quepasaapp-2e0f7",
      storageBucket: "quepasaapp-2e0f7.firebasestorage.app",
      messagingSenderId: "500826556029",
      appId: "1:500826556029:web:707b10faf864433d71d314",
      measurementId: "G-ZL2TN8H31C"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Utility functions
    function makeRoomCode() {
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 6; ++i) code += chars[Math.floor(Math.random() * chars.length)];
      return code;
    }
    function drawQR(code) {
      const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(code)}`;
      new QRious({
        element: document.getElementById('qrCanvas'),
        value: url,
        size: 190,
        background: '#fff',
        foreground: '#111'
      });
    }

    // State
    let myId = Math.random().toString(36).slice(2,9);
    let myRoomCode = null;
    let isHost = false;
    let chatRef = null;

    function joinRoomAndShow(code, setHost) {
      myRoomCode = code;
      isHost = !!setHost;
      document.getElementById('roomCodeDisplay').textContent = code.split('').join(' ');
      drawQR(code);
      setupChatFirebase(code);
      // Clean up qr-reader if needed
      if (window.html5QrCodeObj) {
        window.html5QrCodeObj.stop();
        document.getElementById('qr-reader').style.display = 'none';
      }
    }
    function setupChatFirebase(room) {
      if (chatRef) chatRef.off();
      chatRef = db.ref('rooms/' + room + '/chat');
      chatRef.on('value', snap => {
        const chat = snap.val() || [];
        updateChatHistory(chat);
      });
    }
    function updateChatHistory(chat) {
      const chatDiv = document.getElementById('chatHistory');
      chatDiv.innerHTML = "";
      chat.forEach(msg => {
        let div = document.createElement('div');
        div.className = "chat-message" + (msg.who === myId ? " me" : "");
        div.textContent = msg.text;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
    // Chat send
    document.getElementById('chatForm').onsubmit = function(e) {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || !myRoomCode) return;
      chatRef.once('value').then(snap => {
        const chat = snap.val() || [];
        chat.push({ who: myId, text });
        chatRef.set(chat);
        input.value = "";
      });
    };
    // Leave room (host removes room)
    document.getElementById('leaveBtn').onclick = () => {
      if (isHost && myRoomCode) db.ref('rooms/' + myRoomCode).remove();
      myRoomCode = null; isHost = false;
      startRoom();
    };

    // QR Camera Scan for Join Room
    document.getElementById('scanQrBtn').onclick = () => {
      const qrReader = document.getElementById('qr-reader');
      qrReader.style.display = 'block';
      if (window.html5QrCodeObj) window.html5QrCodeObj.stop();
      window.html5QrCodeObj = new Html5Qrcode("qr-reader");
      window.html5QrCodeObj.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 180 },
        qrCodeMessage => {
          try {
            let url = new URL(qrCodeMessage, location.origin);
            let code = (url.searchParams.get("room") || "").toUpperCase();
            if (/^[A-Z2-9]{6}$/.test(code)) {
              window.html5QrCodeObj.stop();
              qrReader.style.display = 'none';
              db.ref('rooms/' + code + '/meta').once('value').then(snap => {
                if (!snap.exists()) {
                  alert("Room not found. / Sala no encontrada.");
                  startRoom(); // fallback to new room
                  return;
                }
                joinRoomAndShow(code, false);
              });
            } else {
              alert("Invalid QR code / C√≥digo QR inv√°lido");
            }
          } catch (e) {
            alert("Invalid QR code / C√≥digo QR inv√°lido");
          }
        },
        errorMessage => {}
      );
    };

    // On load: If ?room=CODE join, else create new
    function startRoom() {
      // Check URL for ?room=CODE
      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get('room');
      if (code && /^[A-Z2-9]{6}$/i.test(code)) {
        code = code.toUpperCase();
        db.ref('rooms/' + code + '/meta').once('value').then(snap => {
          if (!snap.exists()) {
            // Room not found, create new
            createAndJoinNewRoom();
          } else {
            joinRoomAndShow(code, false);
          }
        });
      } else {
        createAndJoinNewRoom();
      }
    }
    function createAndJoinNewRoom() {
      let code = makeRoomCode();
      myRoomCode = code;
      isHost = true;
      db.ref('rooms/' + code + '/meta').set({
        created: Date.now(),
        hostId: myId
      }).then(() => {
        joinRoomAndShow(code, true);
      });
    }
    // Ephemeral: destroy room if host leaves page
    window.onbeforeunload = () => {
      if (isHost && myRoomCode) db.ref('rooms/' + myRoomCode).remove();
    };
    window.addEventListener('DOMContentLoaded', startRoom);
  </script>
</body>
</html>
