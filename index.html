<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Que Pasa</title>
  <link rel="icon" href="QuePasaLogo.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: #23272a;
      color: #fff;
      font-family: 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
    }
    .screen {
      width: 100vw;
      min-height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      position: absolute;
      left: 0; top: 0;
      background: #23272a;
      z-index: 1;
      padding-bottom: 56px;
    }
    .screen.active {
      display: flex;
      z-index: 10;
    }
    .logo {
      width: 37vw;
      max-width: 280px;
      min-width: 120px;
      aspect-ratio: 1/1;
      margin-bottom: 28px;
      user-select: none;
      display: block;
    }
    .app-title {
      font-size: 3em;
      color: #1da365;
      font-weight: bold;
      letter-spacing: 0.03em;
      margin-bottom: 12px;
      text-shadow: 0 2px 24px #0009;
      user-select: none;
    }
    .tap-to-enter {
      margin-top: 52px;
      color: #fff7;
      font-size: 1.1em;
      animation: blink 1.2s linear infinite alternate;
      user-select: none;
      cursor: pointer;
    }
    @keyframes blink {
      0% { opacity: 1;}
      100% { opacity: 0.2;}
    }
    .menu-btn {
      width: 70vw;
      max-width: 330px;
      min-width: 160px;
      padding: 20px 0;
      margin: 18px 0;
      border-radius: 10px;
      border: none;
      background: #1da365;
      color: #fff;
      font-size: 1.3em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.18s, transform 0.15s;
      box-shadow: 0 2px 8px #0002;
    }
    .menu-btn:hover {
      background: #149150;
      transform: translateY(-2px) scale(1.03);
    }
    .input {
      padding: 15px;
      font-size: 1.1em;
      border-radius: 8px;
      border: none;
      margin-bottom: 18px;
      width: 70vw;
      max-width: 320px;
      background: #31343a;
      color: #fffc;
      outline: none;
      box-shadow: 0 1px 4px #0002;
    }
    .input:focus {
      background: #41444a;
    }
    .label {
      font-size: 1.1em;
      margin-bottom: 8px;
      color: #fff8;
    }
    .leave-btn, .self-destruct-btn {
      background: #e74c3c;
      color: #fff;
      padding: 12px 28px;
      border-radius: 9px;
      border: none;
      font-size: 1em;
      font-weight: bold;
      margin-top: 30px;
      cursor: pointer;
      transition: background 0.13s;
      user-select: none;
      position: relative;
    }
    .leave-btn:hover, .self-destruct-btn:hover, .self-destruct-btn.holding {
      background: #c0392b;
    }
    .room-code {
      font-size: 1.8em;
      color: #1da365;
      background: #222b;
      padding: 16px 30px;
      border-radius: 14px;
      margin-top: 20px;
      margin-bottom: 18px;
      letter-spacing: 0.25em;
      user-select: all;
      font-family: 'Courier New', Courier, monospace;
      box-shadow: 0 2px 8px #0002;
    }
    .room-qr {
      margin: 18px 0 8px 0;
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 8px #0003;
      display: inline-block;
    }
    .chat-box {
      width: 94vw;
      max-width: 500px;
      min-width: 220px;
      background: #252a2e;
      border-radius: 14px;
      box-shadow: 0 1px 8px #0003;
      padding: 14px 0 6px 0;
      margin: 12px 0 0 0;
      display: flex;
      flex-direction: column;
      height: 36vh;
      min-height: 170px;
      max-height: 260px;
      overflow: hidden;
    }
    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 0 18px 0 18px;
      display: flex;
      flex-direction: column;
    }
    .chat-message {
      margin: 7px 0;
      padding: 8px 13px;
      max-width: 80%;
      border-radius: 10px;
      background: #1da36522;
      color: #fff;
      font-size: 1.08em;
      font-weight: 500;
      word-break: break-word;
      box-shadow: 0 1px 2px #0001;
    }
    .chat-message.me {
      align-self: flex-end;
      background: #1da365;
      color: #fff;
      font-weight: bold;
    }
    .chat-message.system {
      background: #23272a;
      color: #1da365;
      font-size: 0.98em;
      align-self: center;
      font-style: italic;
      box-shadow: none;
    }
    .chat-input-row {
      display: flex;
      gap: 8px;
      padding: 7px 10px 8px 10px;
      align-items: center;
    }
    .chat-input {
      flex: 1;
      font-size: 1.11em;
      padding: 11px 14px;
      border-radius: 7px;
      border: none;
      outline: none;
      background: #31343a;
      color: #fff;
    }
    .chat-send-btn {
      background: #1da365;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 10px 18px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.17s;
    }
    .chat-send-btn:hover {
      background: #149150;
    }
    .scan-btn {
      background: #009c34;
      color: #fff;
      border-radius: 7px;
      border: none;
      padding: 10px 20px;
      font-size: 1em;
      font-weight: bold;
      margin-bottom: 10px;
      cursor: pointer;
    }
    .scan-btn:hover { background: #006a22; }
    #qr-reader { margin: 12px auto; width: 240px; }
    /* ...rest of your styles... */
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <!-- Splash Screen -->
  <div class="screen active" id="splash">
    <img class="logo" src="QuePasaLogo.png" alt="Que Pasa logo" />
    <div class="app-title">Que Pasa</div>
    <div class="tap-to-enter" id="splashEnter">Tap to Start</div>
  </div>
  <!-- Menu -->
  <div class="screen" id="menu">
    <button class="menu-btn" id="createRoomBtn">Create Room</button>
    <button class="menu-btn" id="joinRoomBtn">Enter Room</button>
  </div>
  <!-- Create Room Screen -->
  <div class="screen" id="createRoomScreen">
    <div class="label">Set Max Room Size (2-9):</div>
    <input class="input" type="number" id="maxSizeInput" min="2" max="9" value="5" />
    <button class="menu-btn" id="confirmCreateBtn">Create</button>
    <button class="leave-btn" id="backToMenuFromCreate">Back</button>
    <div class="error" id="createError"></div>
  </div>
  <!-- Join Room Screen -->
  <div class="screen" id="joinRoomScreen">
    <div class="label">Enter Room Code:</div>
    <input class="input" id="joinCodeInput" maxlength="12" placeholder="Paste or type code..." />
    <button class="menu-btn" id="confirmJoinBtn">Join</button>
    <button class="scan-btn" id="scanQrBtn">Scan QR</button>
    <div id="qr-reader" style="display:none;"></div>
    <button class="leave-btn" id="backToMenuFromJoin">Back</button>
    <div class="error" id="joinError"></div>
    <div style="margin-top:24px;color:#fff7;font-size:0.93em;">Use camera to scan a room QR code!</div>
  </div>
  <!-- Room Screen -->
  <div class="screen" id="roomScreen">
    <div class="label">Room QR Code (flash to invite):</div>
    <canvas id="qrCanvas" class="room-qr"></canvas>
    <div class="room-code" id="roomCodeDisplay"></div>
    <div style="margin-bottom:10px;">
      <button class="menu-btn" id="flashQrBtn">Show QR Fullscreen</button>
      <button class="menu-btn" id="flashCodeBtn">Flash Letters</button>
      <button class="menu-btn" id="flashCashBtn">Flash CashApp</button>
    </div>
    <div class="chat-box">
      <div class="chat-history" id="chatHistory"></div>
      <form class="chat-input-row" id="chatForm" autocomplete="off">
        <input class="chat-input" id="chatInput" placeholder="Type a message..." autocomplete="off" />
        <button type="submit" class="chat-send-btn">Send</button>
      </form>
    </div>
    <!-- Self Destruct Button (replacing leave room) -->
    <button class="self-destruct-btn" id="selfDestructBtn">
      <span id="selfDestructText">Self Destruct Room</span>
      <div id="selfDestructProgress"></div>
    </button>
  </div>
  <!-- Big flash overlay (for code/QR/logo) -->
  <div class="big-flash" id="bigFlash" style="display:none;"></div>
  <!-- Voting Dialog -->
  <div class="vote-dialog" id="voteDialog" style="display:none;">
    <div class="vote-box">
      <div id="voteText">A new person wants to join. Approve?</div>
      <div class="vote-btn-row">
        <button class="vote-btn yes" id="voteYesBtn">üëç Yes</button>
        <button class="vote-btn no" id="voteNoBtn">üëé No</button>
      </div>
    </div>
  </div>
  <!-- Cash App Support Button -->
  <div class="cashapp-support">
    <a class="cashapp-btn"
       href="https://cash.app/$QuePasaAPP"
       target="_blank"
       rel="noopener">
      <img class="cashapp-logo" src="CashappQR.png" alt="Cash App Logo"/>
      Support me on Cash App
    </a>
    <div style="color:#fff8; font-size:1em;">
      <b>Cash App:</b> $QuePasaAPP
    </div>
  </div>
  <script>
    // "Globals"
    let myId = Math.random().toString(36).slice(2,9);
    let myRoomCode = null;
    let isHost = false;
    let myName = "You";
    let chatRef = null;
    function makeRoomCode() {
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 6; ++i) code += chars[Math.floor(Math.random() * chars.length)];
      return code;
    }
    function drawQR(canvasId, code) {
      const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(code)}`;
      new QRious({
        element: document.getElementById(canvasId),
        value: url,
        size: 180,
        background: '#fff',
        foreground: '#111'
      });
    }
    function show(screen) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screen).classList.add('active');
    }
    document.getElementById('splashEnter').onclick = () => show('menu');
    document.getElementById('splash').onclick = () => show('menu');
    document.getElementById('createRoomBtn').onclick = () => show('createRoomScreen');
    document.getElementById('joinRoomBtn').onclick = () => show('joinRoomScreen');
    document.getElementById('backToMenuFromCreate').onclick = () => {
      document.getElementById('createError').textContent = "";
      show('menu');
    };
    document.getElementById('backToMenuFromJoin').onclick = () => {
      document.getElementById('joinError').textContent = "";
      show('menu');
      if (window.html5QrCodeObj) {
        window.html5QrCodeObj.stop();
        document.getElementById('qr-reader').style.display = 'none';
      }
    };
    document.getElementById('confirmCreateBtn').onclick = () => {
      const max = parseInt(document.getElementById('maxSizeInput').value);
      if (!(max >= 2 && max <= 9)) {
        document.getElementById('createError').textContent = "Choose a size between 2 and 9.";
        return;
      }
      let code = makeRoomCode();
      myRoomCode = code;
      isHost = true;
      db.ref('rooms/' + code + '/meta').set({
        size: max,
        created: Date.now(),
        hostId: myId
      }).then(() => {
        joinRoomAndShow(code);
      });
    };
    document.getElementById('confirmJoinBtn').onclick = () => {
      const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
      const err = document.getElementById('joinError');
      err.textContent = "";
      if (!/^[A-Z2-9]{6}$/.test(code)) {
        err.textContent = "Invalid code format.";
        return;
      }
      db.ref('rooms/' + code + '/meta').once('value').then(snap => {
        if (!snap.exists()) {
          err.textContent = "Room not found.";
          return;
        }
        myRoomCode = code;
        isHost = false;
        joinRoomAndShow(code);
      });
    };
    // QR Camera Scan for Join Room
    document.getElementById('scanQrBtn').onclick = () => {
      const qrReader = document.getElementById('qr-reader');
      qrReader.style.display = 'block';
      if (window.html5QrCodeObj) window.html5QrCodeObj.stop();
      window.html5QrCodeObj = new Html5Qrcode("qr-reader");
      window.html5QrCodeObj.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          try {
            let url = new URL(qrCodeMessage, location.origin);
            let code = (url.searchParams.get("room") || "").toUpperCase();
            if (/^[A-Z2-9]{6}$/.test(code)) {
              document.getElementById('joinCodeInput').value = code;
              document.getElementById('joinError').textContent = "";
              window.html5QrCodeObj.stop();
              qrReader.style.display = 'none';
              document.getElementById('confirmJoinBtn').click();
            } else {
              document.getElementById('joinError').textContent = "Invalid QR code.";
            }
          } catch (e) {
            document.getElementById('joinError').textContent = "Invalid QR code.";
          }
        },
        errorMessage => {}
      );
    };
    function joinRoomAndShow(code) {
      drawQR('qrCanvas', code);
      document.getElementById('roomCodeDisplay').textContent = code.split('').join(' ');
      setupChatFirebase(code);
      show('roomScreen');
    }
    const destructBtn = document.getElementById('selfDestructBtn');
    const destructText = document.getElementById('selfDestructText');
    const destructProgress = document.getElementById('selfDestructProgress');
    let destructInterval, holdStart;
    function handleDestructStart(e) {
      if (!myRoomCode || !isHost) return;
      holdStart = Date.now();
      destructBtn.classList.add('holding');
      destructProgress.style.width = '0';
      let duration = 1500;
      destructInterval = setInterval(() => {
        let elapsed = Date.now() - holdStart;
        let percent = Math.min(100, (elapsed / duration) * 100);
        destructProgress.style.width = percent + '%';
        if (elapsed >= duration) {
          clearInterval(destructInterval);
          destructBtn.classList.remove('holding');
          destructProgress.style.width = '100%';
          db.ref('rooms/' + myRoomCode).remove();
          myRoomCode = null;
          isHost = false;
          show('menu');
          destructProgress.style.width = '0';
          destructText.textContent = 'Self Destruct Room';
        }
      }, 30);
      e.preventDefault && e.preventDefault();
      return false;
    }
    function handleDestructEnd() {
      clearInterval(destructInterval);
      destructBtn.classList.remove('holding');
      destructProgress.style.width = '0';
      destructText.textContent = 'Self Destruct Room';
    }
    destructBtn.onmousedown = handleDestructStart;
    destructBtn.ontouchstart = handleDestructStart;
    destructBtn.onmouseup = handleDestructEnd;
    destructBtn.onmouseleave = handleDestructEnd;
    destructBtn.ontouchend = handleDestructEnd;
    document.getElementById('flashQrBtn').onclick = () => {
      flashSequence([
        { type: 'logo', duration: 800 },
        { type: 'qr', duration: 2000 },
        { type: 'logo', duration: 700 }
      ]);
    };
    document.getElementById('flashCodeBtn').onclick = () => {
      const code = myRoomCode;
      const seq = [{ type: 'logo', duration: 800 }];
      for (let ch of code) {
        seq.push({ type: 'letter', letter: ch, duration: 800 });
      }
      seq.push({ type: 'logo', duration: 700 });
      flashSequence(seq);
    };
    document.getElementById('flashCashBtn').onclick = () => {
      flashSequence([
        { type: 'logo', duration: 600 },
        { type: 'cashapp', duration: 1700 },
        { type: 'logo', duration: 600 }
      ]);
    };
    function flashSequence(seq) {
      const flash = document.getElementById('bigFlash');
      let i = 0;
      flash.style.display = 'flex';
      next();
      function next() {
        if (i >= seq.length) {
          flash.style.display = 'none';
          flash.classList.remove('flash-green');
          return;
        }
        flash.innerHTML = "";
        const item = seq[i++];
        flash.classList.remove('flash-green');
        if (item.type === "logo") {
          flash.innerHTML = `<img src="QuePasaLogo.png" alt="Que Pasa logo" class="flash-logo" />`;
        } else if (item.type === "letter") {
          flash.classList.add('flash-green');
          flash.innerHTML = `<span class="flash-letter">${item.letter}</span>`;
        } else if (item.type === "qr") {
          const qrCanvas = document.createElement('canvas');
          qrCanvas.width = qrCanvas.height = 320;
          qrCanvas.className = "flash-qr";
          flash.appendChild(qrCanvas);
          new QRious({
            element: qrCanvas,
            value: `${location.origin}${location.pathname}?room=${encodeURIComponent(myRoomCode)}`,
            size: 320,
            background: '#fff',
            foreground: '#23272a'
          });
        } else if (item.type === "cashapp") {
          flash.innerHTML = `<img src="CashappQR.png" alt="Cash App" class="flash-cashapp" />`;
        }
        setTimeout(next, item.duration);
      }
    }
    function setupChatFirebase(room) {
      if (chatRef) chatRef.off();
      chatRef = db.ref('rooms/' + room + '/chat');
      chatRef.on('value', snap => {
        const chat = snap.val() || [];
        updateChatHistory(chat);
      });
    }
    document.getElementById('chatForm').onsubmit = function(e) {
      e.preventDefault();
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || !myRoomCode) return;
      chatRef.once('value').then(snap => {
        const chat = snap.val() || [];
        chat.push({ who: myId, text });
        chatRef.set(chat);
        input.value = "";
      });
    };
    function updateChatHistory(chat) {
      const chatDiv = document.getElementById('chatHistory');
      chatDiv.innerHTML = "";
      chat.forEach(msg => {
        let div = document.createElement('div');
        div.className = "chat-message" + (msg.who === myId ? " me" : "");
        if (typeof msg.system !== "undefined") div.className += " system";
        div.textContent = (msg.system ? "" : (msg.who === myId ? "You: " : "")) + msg.text;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }
    function triggerVoteDialog() {
      const dialog = document.getElementById('voteDialog');
      dialog.style.display = "flex";
      document.getElementById('voteText').textContent = "A new person wants to join. Approve?";
      document.getElementById('voteYesBtn').onclick = () => {
        dialog.style.display = "none";
        joinRoomAndShow(myRoomCode);
      };
      document.getElementById('voteNoBtn').onclick = () => {
        dialog.style.display = "none";
      };
    }
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get('room');
      if (code && /^[A-Z2-9]{6}$/i.test(code)) {
        code = code.toUpperCase();
        myRoomCode = code;
        isHost = false;
        joinRoomAndShow(code);
      }
    });
    window.onbeforeunload = () => {
      if (isHost && myRoomCode) db.ref('rooms/' + myRoomCode).remove();
    };
  </script>
</body>
</html>
